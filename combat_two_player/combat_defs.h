// 16 directions × 8x8 tank sprites
// dir 0 = UP, 4 = RIGHT, 8 = DOWN, 12 = LEFT (clockwise)
// Generated from 4 base sprites - edit only the bases above!

const uint8_t tank[16][8] PROGMEM = {
  {  // Direction 0
    0x10,   // 00010000
    0x10,   // 00010000
    0xD6,   // 11010110
    0xFE,   // 11111110
    0xFE,   // 11111110
    0xC6,   // 11000110
    0xC6,   // 11000110
    0x00    // 00000000
  },
  {  // Direction 1
    0x19,   // 00011001
    0x3A,   // 00111010
    0x7E,   // 01111110
    0xFC,   // 11111100
    0xDF,   // 11011111
    0x1E,   // 00011110
    0x0C,   // 00001100
    0x18    // 00011000
  },
  {  // Direction 2
    0x0E,   // 00001110
    0x38,   // 00111000
    0xFB,   // 11111011
    0x7C,   // 01111100
    0x18,   // 00011000
    0x0F,   // 00001111
    0x1E,   // 00011110
    0x30    // 00110000
  },
  {  // Direction 3
    0x06,   // 00000110
    0x7E,   // 01111110
    0x7C,   // 01111100
    0x3D,   // 00111101
    0x26,   // 00100110
    0x3C,   // 00111100
    0x7E,   // 01111110
    0xE0    // 11100000
  },
  {  // Direction 4
    0x7C,   // 01111100
    0x7C,   // 01111100
    0x18,   // 00011000
    0x1F,   // 00011111
    0x18,   // 00011000
    0x7C,   // 01111100
    0x7C,   // 01111100
    0x00    // 00000000
  },
  {  // Direction 5
    0xE0,   // 11100000
    0x7E,   // 01111110
    0x3C,   // 00111100
    0x26,   // 00100110
    0x3D,   // 00111101
    0x7C,   // 01111100
    0x7E,   // 01111110
    0x06    // 00000110
  },
  {  // Direction 6
    0x30,   // 00110000
    0x1E,   // 00011110
    0x0F,   // 00001111
    0x18,   // 00011000
    0x7C,   // 01111100
    0xFB,   // 11111011
    0x38,   // 00111000
    0x0E    // 00001110
  },
  {  // Direction 7
    0x18,   // 00011000
    0x0C,   // 00001100
    0x1E,   // 00011110
    0xDF,   // 11011111
    0xFC,   // 11111100
    0x7E,   // 01111110
    0x3A,   // 00111010
    0x19    // 00011001
  },
  {  // Direction 8
    0x00,   // 00000000
    0xC6,   // 11000110
    0xC6,   // 11000110
    0xFE,   // 11111110
    0xFE,   // 11111110
    0xD6,   // 11010110
    0x10,   // 00010000
    0x10    // 00010000
  },
  {  // Direction 9
    0x18,   // 00011000
    0x30,   // 00110000
    0x78,   // 01111000
    0xFB,   // 11111011
    0x3F,   // 00111111
    0x7E,   // 01111110
    0x5C,   // 01011100
    0x98    // 10011000
  },
  {  // Direction 10
    0x0C,   // 00001100
    0x78,   // 01111000
    0xF0,   // 11110000
    0x18,   // 00011000
    0x3E,   // 00111110
    0xDF,   // 11011111
    0x1C,   // 00011100
    0x70    // 01110000
  },
  {  // Direction 11
    0x07,   // 00000111
    0x7E,   // 01111110
    0x3C,   // 00111100
    0x64,   // 01100100
    0xBC,   // 10111100
    0x3E,   // 00111110
    0x7E,   // 01111110
    0x60    // 01100000
  },
  {  // Direction 12
    0x3E,   // 00111110
    0x3E,   // 00111110
    0x18,   // 00011000
    0xF8,   // 11111000
    0x18,   // 00011000
    0x3E,   // 00111110
    0x3E,   // 00111110
    0x00    // 00000000
  },
  {  // Direction 13
    0x60,   // 01100000
    0x7E,   // 01111110
    0x3E,   // 00111110
    0xBC,   // 10111100
    0x64,   // 01100100
    0x3C,   // 00111100
    0x7E,   // 01111110
    0x07    // 00000111
  },
  {  // Direction 14
    0x70,   // 01110000
    0x1C,   // 00011100
    0xDF,   // 11011111
    0x3E,   // 00111110
    0x18,   // 00011000
    0xF0,   // 11110000
    0x78,   // 01111000
    0x0C    // 00001100
  },
  {  // Direction 15
    0x98,   // 10011000
    0x5C,   // 01011100
    0x7E,   // 01111110
    0x3F,   // 00111111
    0xFB,   // 11111011
    0x78,   // 01111000
    0x30,   // 00110000
    0x18    // 00011000
  }
};

// Usage: u8g2.drawXBMP(x, y, 8, 8, tank[current_direction]);


const uint8_t frame_bitmap[][1024] PROGMEM = {
  // Row 0 – full line
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
  // Rows 1–62 – leftmost + rightmost pixel on
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  // Row 63 – full line
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
};

uint8 current_background_frame=0;


// FIXED wall_hit function - treat ALL out-of-bounds as wall (including negatives cast to 255)
bool wall_hit(const uint8_t* bitmap, uint8_t x, uint8_t y) {
    if (x > SCREEN_WIDTH - 1 || y > SCREEN_HEIGHT - 1) return true;  // ← CHANGED: now catches 128-255 & negatives
    //uint8_t byte_idx  = (y << 4) + (x >> 3);
   // uint8_t byte_idx  = y*(SCREEN_WIDTH/8) + (x / 8 ); // y*16 + (x/8) since 128 pixels / 8 bits per byte = 16 bytes per row
   uint16_t byte_idx = y * (uint16_t)(SCREEN_WIDTH >> 3) + (x >> 3);
   uint8_t bit_mask  = 0x80 >> (x & 7); // 10000000 >> (x % 8) shifr 0x80 until it matches the bit we want
    uint8_t b = pgm_read_byte(bitmap + byte_idx);
//Serial.println("wall_hit: x=" + String(x) + " y=" + String(y) + " byte_idx=" + String(byte_idx) + " bit_mask=" + String(bit_mask, BIN) + " byte_value=" + String(b, BIN)+" result=" + String((b & bit_mask) != 0));

    return b & bit_mask;
}



static const float dx_table[16] = {
     0.000f,   // dir  0  ( -90.0°)
     0.383f,   // dir  1  ( -67.5°)
     0.707f,   // dir  2  ( -45.0°)
     0.924f,   // dir  3  ( -22.5°)
     1.000f,   // dir  4  (   0.0°)
     0.924f,   // dir  5  (  22.5°)
     0.707f,   // dir  6  (  45.0°)
     0.383f,   // dir  7  (  67.5°)
     0.000f,   // dir  8  (  90.0°)
    -0.383f,   // dir  9  ( 112.5°)
    -0.707f,   // dir 10  ( 135.0°)
    -0.924f,   // dir 11  ( 157.5°)
    -1.000f,   // dir 12  ( 180.0°)
    -0.924f,   // dir 13  ( 202.5°)
    -0.707f,   // dir 14  ( 225.0°)
    -0.383f,    // dir 15  ( 247.5°)
};

static const float dy_table[16] = {
    -1.000f,   // dir  0  ( -90.0°)
    -0.924f,   // dir  1  ( -67.5°)
    -0.707f,   // dir  2  ( -45.0°)
    -0.383f,   // dir  3  ( -22.5°)
     0.000f,   // dir  4  (   0.0°)
     0.383f,   // dir  5  (  22.5°)
     0.707f,   // dir  6  (  45.0°)
     0.924f,   // dir  7  (  67.5°)
     1.000f,   // dir  8  (  90.0°)
     0.924f,   // dir  9  ( 112.5°)
     0.707f,   // dir 10  ( 135.0°)
     0.383f,   // dir 11  ( 157.5°)
     0.000f,   // dir 12  ( 180.0°)
    -0.383f,   // dir 13  ( 202.5°)
    -0.707f,   // dir 14  ( 225.0°)
    -0.924f,    // dir 15  ( 247.5°)
};


// bounce trnsition table
static const uint8_t bounce_table_v[16] = { // for hitting vertical wall
     8,   // from dir  0 ( -90.0°) not possible . 
     15,   // from dir  1  ( -67.5°) bounce back and up
     14,   // from dir  2  ( -45.0°)
     13,   // from dir  3  ( -22.5°)
     12,   // from dir  4  (   0.0°)
     11,   // from dir  5  (  22.5°)
     10,   // from dir  6  (  45.0°)
     9,   // from dir  7  (  67.5°)
     8,   // from dir  8  (  90.0°) not possible
    7,   // from dir 9 (112.5°)
    6,   // from dir 10  ( 135.0°)
    5,   // from dir 11  ( 157.5°)
    4,   // from dir 12  (180.0°)
    3,   // from dir 13  (202.5°)
    2,   // from dir14   (225.0°)
    1    // from dir15   (247.5°)
};
static const uint8_t bounce_table_h[16] = { // for hitting horizontal wall
     8,   // from dir  0 ( -90.0°) direct reflection  
     7,   // from dir  1  ( -67.5°) bounce back and up
     6,   // from dir  2  ( -45.0°)
     5,   // from dir  3  ( -22.5°)
     4,   // from dir  4  (   0.0°) // not possible
     3,   // from dir  5  (  22.5°)
     2,   // from dir  6  (  45.0°)
     1,   // from dir  7  (  67.5°)
     0,   // from dir8 (90.0°) direct refection.
    15,   // from dir9 (112.5°)
    14,   // from dir10 (135.0°)
    13,   // from dir11 (157.5°)
    12,   // from dir12 (180.0°) // not possible
    11,   // from dir13 (202.5°)
    10,   // from dir14 (225.0°)
    9    // from dir15 (247.5°)
} ;

void drawScores_combat() {
  display.setTextSize(1);
  display.setTextColor(WHITE);

  display.setCursor(12, 2);
  display.print(combat.scoreLeft);
  if (isMaster){
    display.print(" M");
  }
    else 
  {
    display.print(" C");
  }
  if (partnerFound) {
    display.print(" P");
  }
  else {
    display.print(" -");
  };

  display.print(" GS:");

  switch(gameState) {
    case STATE_SEARCHING:
      display.print("SRCH");
      break;
    case STATE_READY:
      display.print("REDY");
      break;
    case STATE_PLAYING:
      display.print("PLAY");
      break;
   
  } 

  display.setCursor(SCREEN_WIDTH - 15, 2);
  display.print(combat.scoreRight);
}

 